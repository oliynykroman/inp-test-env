<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INP-first · Form</title>
  <link rel="stylesheet" href="./shared/styles.css" />
  <style>
    form { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:.75rem; }
    label { display:flex; flex-direction:column; gap:.35rem; }
    .actions { grid-column: 1 / -1; display:flex; gap:.5rem; }
  </style>
</head>
<body>
<header><div class="container"><div id="panel"></div></div></header>
<main class="container">
  <div class="card">
    <h2>Form</h2>
    <form id="f"></form>
    <div id="status" class="small"></div>
  </div>
  <div id="app-root"></div>
</main>

<script type="module" src="./shared/rum.js"></script>
<script type="module" src="./shared/panel.js"></script>
<script type="module">
  import { VARIANT, readVariantFromURL, processHeavyWork, postTask } from './shared/interventions.js';
  readVariantFromURL();

  const form = document.getElementById('f');
  const status = document.getElementById('status');

  // Heavier workload knobs for realistic INP stress
  const VALIDATION_WEIGHT = 30000;   // iterations per field (was 5000)
  const SERIALIZE_WEIGHT  = 1500;    // iterations of form serialization per interaction

  function heavySerialize(formEl){
    // CPU-bound, synchronous work that keeps the main thread busy (affects INP in baseline)
    const data = new FormData(formEl);
    let acc = '';
    for (let r = 0; r < SERIALIZE_WEIGHT; r++) {
      for (const [k, v] of data.entries()) {
        acc += k + '=' + v + '&' + r;
      }
      // cheap hash-like math churn
      let h = 0;
      for (let i = 0; i < acc.length; i++) {
        h = (h * 33 + acc.charCodeAt(i)) | 0;
      }
      // transient JSON to add some allocation/GC pressure
      JSON.stringify({ r, len: acc.length, h });
    }
  }

  // Generate 24 fields + actions in JS (no HTML templates)
  form.innerHTML = [
    ...Array.from({length: 24}, (_, i) =>
      `<label>Field ${i+1}<input type="text" name="f${i+1}" placeholder="value ${i+1}"></label>`
    ),
    `<div class="actions">
       <button type="button" class="btn" id="fill">Fill random</button>
       <button type="submit" class="btn primary">Submit</button>
     </div>`
  ].join('');

  // Intentionally heavy validation to leave room to optimize INP
  function validateField(el){
    const v = el.value || ''; let ok = true;
    for (let i = 0; i < VALIDATION_WEIGHT; i++) {
      ok = ok && /(?!.*\s{2,})^[\w\s.-]{0,64}$/.test(v);
      // numeric churn to simulate CPU load
      let x = (i * 2654435761) | 0;       // Knuth multiplier
      x = Math.imul(x ^ (x >>> 13), 1274126177);
    }
    return ok;
  }

  async function validateAll(){
    const inputs = [...form.querySelectorAll('input')]; let all = true;
    if (VARIANT.slicing) {
      for (const el of inputs){
        const run = () => {
          const ok = validateField(el);
          el.style.borderColor = ok ? '#2e7d32' : '#b33';
          all = all && ok;
        };
        if (VARIANT.prioritization) await postTask(run, 'user-blocking');
        else await postTask(run);
      }
    } else {
      for (const el of inputs){
        const ok = validateField(el);
        el.style.borderColor = ok ? '#2e7d32' : '#b33';
        all = all && ok;
      }
    }
    return all;
  }

  // Fill with random values
  form.addEventListener('click', async (e) => {
    if (e.target.id !== 'fill') return;
    for (const el of form.querySelectorAll('input')){
      el.value = Math.random().toString(36).slice(2,8);
    }
    // Do synchronous churn to impact the 'fill' interaction in baseline; yield when slicing is enabled
    if (VARIANT.slicing) {
      if (VARIANT.prioritization) await postTask(() => heavySerialize(form), 'user-visible');
      else await postTask(() => heavySerialize(form));
    } else {
      heavySerialize(form);
    }
    await processHeavyWork();
  });

  // Submit with validation
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.textContent = 'Validating…';
    const ok = await validateAll();

    // Heavier synchronous work to align with the submit interaction
    if (VARIANT.slicing) {
      if (VARIANT.prioritization) await postTask(() => heavySerialize(form), 'background');
      else await postTask(() => heavySerialize(form));
    } else {
      heavySerialize(form);
    }

    // Additional CPU work (monolithic in baseline; sliced when I2/I3 enabled)
    await processHeavyWork();

    status.textContent = ok ? '✔ Data valid, submitted.' : '✖ Validation errors.';
  });
</script>
</body>
</html>